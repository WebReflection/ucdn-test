import t from"../../umap/esm/index.js";import e from"../../uparser/esm/index.js";import{isArray as n}from"../../uarray/esm/index.js";import{persistent as r}from"../../uwire/esm/index.js";import{handlers as o}from"./handlers.js";import{createFragment as s,createPath as l,createWalker as a,importNode as p}from"./node.js";const u=t(new WeakMap);export const createCache=()=>({stack:[],entry:null,wire:null});const i=(t,n)=>{const{content:r,nodes:i}=u.get(n)||u.set(n,((t,n)=>{const r=e(n,"isµ","svg"===t),o=s(r,t),p=a(o),u=[],i=n.length-1;let c=0,m="isµ"+c;for(;c<i;){const t=p.nextNode();if(!t)throw"bad template: "+r;if(8===t.nodeType)t.textContent===m&&(u.push({type:"node",path:l(t)}),m="isµ"+ ++c);else{for(;t.hasAttribute(m);)u.push({type:"attr",path:l(t),name:t.getAttribute(m)}),t.removeAttribute(m),m="isµ"+ ++c;/^(?:style|textarea)$/i.test(t.tagName)&&t.textContent.trim()===`\x3c!--${m}--\x3e`&&(u.push({type:"text",path:l(t)}),m="isµ"+ ++c)}}return{content:o,nodes:u}})(t,n)),c=p.call(document,r,!0);return{content:c,updates:i.map(o,c)}};export const unroll=(t,{type:e,template:n,values:o})=>{const{length:s}=o;c(t,o,s);let{entry:l}=t;l&&l.template===n&&l.type===e||(t.entry=l=((t,e)=>{const{content:n,updates:r}=i(t,e);return{type:t,template:e,content:n,updates:r,wire:null}})(e,n));const{content:a,updates:p,wire:u}=l;for(let t=0;t<s;t++)p[t](o[t]);return u||(l.wire=r(a))};const c=({stack:t},e,r)=>{for(let o=0;o<r;o++){const r=e[o];r instanceof Hole?e[o]=unroll(t[o]||(t[o]={stack:[],entry:null,wire:null}),r):n(r)?c(t[o]||(t[o]={stack:[],entry:null,wire:null}),r,r.length):t[o]=null}r<t.length&&t.splice(r)};export function Hole(t,e,n){this.type=t,this.template=e,this.values=n}